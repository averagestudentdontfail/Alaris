# Build Warnings Baseline - First Run

**Date**: 2025-11-20
**Build Command**: `dotnet build` (with TreatWarningsAsErrors=true)
**Result**: 10,744 errors (all in Alaris.Quantlib)

---

## Summary

All errors originate from **Alaris.Quantlib**, which is SWIG-generated C++/CLI wrapper code for QuantLib. This is not authored code and cannot be practically fixed.

### Error Breakdown

| Error Code | Count | Description | Component |
|------------|-------|-------------|-----------|
| CA5392 | 10,744 | P/Invoke methods missing DefaultDllImportSearchPaths attribute | Alaris.Quantlib |

### Affected File

- `/home/sunny/.project/Alaris/Alaris.Quantlib/NQuantLibcPINVOKE.cs` - SWIG-generated P/Invoke wrapper

---

## CA5392: DefaultDllImportSearchPaths

**Rule**: P/Invoke methods should use `DefaultDllImportSearchPaths` attribute for security.

**Rationale**:
- Prevents DLL hijacking attacks on Windows
- Specifies where the runtime should search for native libraries
- Security best practice for production applications

**Example**:
```csharp
// ❌ SWIG generates this:
[DllImport("NQuantLibc")]
public static extern void SomeMethod();

// ✅ Should be:
[DllImport("NQuantLibc")]
[DefaultDllImportSearchPaths(DllImportSearchPath.AssemblyDirectory)]
public static extern void SomeMethod();
```

**Why This Is a Problem for Alaris.Quantlib**:
- `NQuantLibcPINVOKE.cs` is auto-generated by SWIG from QuantLib C++ headers
- Contains **32,000+ lines** of P/Invoke declarations
- Regenerated whenever QuantLib is updated
- Manual fixes would be lost on regeneration

---

## Resolution Strategy

### Approach: Exclude Alaris.Quantlib from Strict Enforcement

**Rationale**:
1. **Auto-generated Code**: We don't author this code, SWIG does
2. **Impractical to Fix**: Would require modifying SWIG toolchain
3. **Low Risk for Linux**: DLL hijacking is primarily a Windows attack vector
4. **Focus on Authored Code**: Our enforcement should target Strategy, Double, and Test components

**Implementation**:
Updated `Alaris.Quantlib/Alaris.Quantlib.csproj`:
```xml
<!-- Exclude SWIG-generated code from strict enforcement -->
<TreatWarningsAsErrors>false</TreatWarningsAsErrors>
<EnforceCodeStyleInBuild>false</EnforceCodeStyleInBuild>

<!-- Suppress common warnings from SWIG-generated code -->
<NoWarn>$(NoWarn);CS1591;CA5392;CA1062;CA2000</NoWarn>
```

**Suppressions**:
- `CS1591`: Missing XML documentation
- `CA5392`: P/Invoke security (this issue)
- `CA1062`: Validate public arguments
- `CA2000`: Dispose objects before losing scope

---

## Security Considerations

### Is This Safe?

**For Alaris on Linux**: ✅ **Yes, acceptable risk**

**Mitigation**:
1. **Deployment**: Native libraries (libNQuantLibc.so, libQuantLib.so) are deployed alongside the assembly
2. **Linux Platform**: DLL hijacking is primarily a Windows vulnerability
3. **Controlled Environment**: Libraries loaded from known locations
4. **No Windows Deployment**: If deploying to Windows in future, revisit this decision

### Alternative Solutions (Not Implemented)

1. **Fork SWIG**: Modify SWIG code generator to add `DefaultDllImportSearchPaths`
   - **Pros**: Fixes root cause
   - **Cons**: Maintenance burden, requires SWIG expertise, upstreaming changes

2. **Post-Process Generated Code**: Script to add attribute after SWIG generation
   - **Pros**: Automated fix
   - **Cons**: Fragile, breaks on SWIG output format changes

3. **Roslyn Source Generator**: Wrap SWIG output with compliant code
   - **Pros**: Clean separation
   - **Cons**: Complex, additional abstraction layer

**Decision**: Suppress warnings for SWIG-generated code. Focus enforcement on authored components.

---

## Next Steps

### Immediate (User Action Required)

Run targeted build to check **authored components only**:

```bash
cd /home/sunny/.project/Alaris

# Build Strategy component only
dotnet build Alaris.Strategy/Alaris.Strategy.csproj

# Build Double component only
dotnet build Alaris.Double/Alaris.Double.csproj
```

### Expected Results

**Best Case**: Zero warnings (full compliance)

**Likely Case**: Small number of warnings in authored code:
- Null safety warnings (CS8600-series)
- Generic exception catches (CA1031)
- Possible complexity warnings (CA1502)

### Week 2 Planning

Once we have the **actual** warning count from Strategy and Double:
1. Categorize warnings by rule
2. Create remediation plan
3. Begin fixing high-priority violations (Rule 10: Generic exceptions)

---

## Component Enforcement Status

| Component | TreatWarningsAsErrors | Enforcement Level | Rationale |
|-----------|----------------------|------------------|-----------|
| Alaris.Strategy | ✅ **true** | **Full** | Authored code |
| Alaris.Double | ✅ **true** | **Full** | Authored code |
| Alaris.Quantlib | ❌ **false** | **Excluded** | SWIG-generated |
| Alaris.Test | ✅ **true** | **Full** | Authored code |

---

## Lessons Learned

### Generated Code Requires Special Handling

**Principle**: High-integrity coding standards apply to **authored code**. Generated code should be isolated and excluded from enforcement.

**Pattern**:
1. Identify generated code (SWIG, EF Core migrations, Razor, etc.)
2. Document why it's generated
3. Assess security impact of suppressions
4. Exclude from enforcement at project level
5. Focus enforcement on authored components

### Directory.Build.props Inheritance

**How It Works**:
- `Directory.Build.props` at solution root applies to all projects
- Individual `.csproj` files can **override** settings
- Exclusions should be explicit and documented

**Best Practice**:
- Default to strict enforcement (Directory.Build.props)
- Opt-out for generated code (project-level override)
- Document every exclusion

---

**Document Version**: 1.0
**Next Update**: After Strategy and Double build results
