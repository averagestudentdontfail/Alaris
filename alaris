#!/bin/bash
# =============================================================================
# Alaris CLI - Unified Trading System Interface
# =============================================================================
# Usage: ./alaris [command] [options]
#   ./alaris                     Launch TUI mode
#   ./alaris backtest create     Create a new backtest
#   ./alaris backtest list       List existing backtests
#   ./alaris run                 Run LEAN algorithm
#   ./alaris help                Show help
# =============================================================================

set -euo pipefail

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_PATH="${SCRIPT_DIR}/Alaris.Host"
CONFIG_FILE="${SCRIPT_DIR}/appsettings.jsonc"
BUILD_CONFIG="${ALARIS_BUILD_CONFIG:-Release}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Print colored message
print_color() {
    local color="$1"
    shift
    echo -e "${color}$*${NC}"
}

# Check prerequisites
check_prerequisites() {
    if ! command -v dotnet &> /dev/null; then
        print_color "$RED" "Error: .NET SDK not found. Please install .NET 9.0 or later."
        exit 1
    fi
    
    if [[ ! -d "$PROJECT_PATH" ]]; then
        print_color "$RED" "Error: Project not found at $PROJECT_PATH"
        exit 1
    fi
}

# Build the project if needed
ensure_built() {
    local dll_path="${PROJECT_PATH}/bin/${BUILD_CONFIG}/net9.0/Alaris.Host.dll"
    local csproj_path="${PROJECT_PATH}/Alaris.Host.csproj"
    
    # Check if rebuild needed
    if [[ ! -f "$dll_path" ]] || [[ "$csproj_path" -nt "$dll_path" ]]; then
        print_color "$YELLOW" "Building Alaris.Host..."
        if dotnet build "$PROJECT_PATH" --configuration "$BUILD_CONFIG" --verbosity quiet; then
            print_color "$GREEN" "Build successful."
        else
            print_color "$RED" "Build failed. Run 'dotnet build' for details."
            exit 1
        fi
    fi
}

# Show version information
show_version() {
    echo "Alaris Trading System v1.0.0"
    echo "  .NET: $(dotnet --version)"
    echo "  Path: $PROJECT_PATH"
    echo "  Config: $BUILD_CONFIG"
}

# Show help
show_help() {
    cat << EOF
Alaris Trading System - CLI Interface

USAGE:
    ./alaris [COMMAND] [OPTIONS]

COMMANDS:
    (no command)      Launch interactive TUI mode
    backtest create   Create a new backtest session
    backtest list     List existing backtest sessions
    run               Execute LEAN algorithm
    version           Show version information
    help              Show this help message

OPTIONS:
    --config FILE     Use alternative config file
    --debug           Build and run in Debug mode

EXAMPLES:
    ./alaris                           # Launch TUI
    ./alaris backtest create NVDA      # Create backtest for NVDA
    ./alaris run --config my.json      # Run with custom config

ENVIRONMENT:
    ALARIS_BUILD_CONFIG   Build configuration (default: Release)

EOF
}

# Main entry point
main() {
    check_prerequisites
    
    # Handle special commands before building
    case "${1:-}" in
        help|--help|-h)
            show_help
            exit 0
            ;;
        version|--version|-v)
            show_version
            exit 0
            ;;
    esac
    
    # Handle debug mode
    if [[ "${1:-}" == "--debug" ]]; then
        BUILD_CONFIG="Debug"
        shift
    fi
    
    ensure_built
    
    # Run the application
    print_color "$BLUE" "  Alaris Trading System"
    echo ""
    
    dotnet run --project "$PROJECT_PATH" --configuration "$BUILD_CONFIG" --no-build -- "$@"
}

main "$@"
